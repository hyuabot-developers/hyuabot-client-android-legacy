name: Android App Build
on:
    push:
        branches:
            - feat/*
            - hotfix/*
            - main
    pull_request:
        branches:
            - main
jobs:
    build:
        - runs-on: self-hosted
        - name: Checkout
            uses: actions/checkout@v3
            with:
                fetch-depth: 0

        - name: Setup JDK 11
            uses: actions/setup-java@v3
            with:
                distribution: 'zulu'
                java-version: 11

        - name: Setup Android SDK
            uses: android-actions/setup-android@v2

        - name: Cache Gradle packages
            uses: actions/cache@v3
            with:
                path: |
                    ~/.gradle/caches
                    ~/.gradle/wrapper
                key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', '**/buildSrc/**/*.kt') }}
                restore-keys: |
                    ${{ runner.os }}-gradle-

        - name: Grant execute permission for gradlew
            run: chmod +x gradlew

        - name: Run ktlint
          run: ./gradlew ktlintCheck

        - name: Run detekt
          run: ./gradlew detekt

        - name: Get sign key
            run: echo $BASE64_KEYSTORE | base64 --decode > app/release-key.jks

        - name: Build Release App Bundle
            run: ./gradlew bundleRelease
